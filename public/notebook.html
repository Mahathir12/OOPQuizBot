<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Notebook ‚Ä¢ OOPQuizBot</title>
<link rel="icon" href="assets/favicon.png"/>

<style>
  :root{
    --bg:#0c0c0c; --text:#111; --white:#fff; --muted:#888; --accent:#0f62fe;
    --shadow:0 10px 30px rgba(0,0,0,.15); --radius:18px; --brand-size:20px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body{color:#111;background:#fff;line-height:1.5;overflow-x:hidden}

  /* Header (same look as Home) */
  .site-header{position:fixed;inset:0 0 auto 0;z-index:50;display:flex;align-items:center;justify-content:space-between;padding:12px 28px;background:rgba(255,255,255,.06);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.15);transition:all .3s ease;color:#fff}
  .site-header.scrolled{background:rgba(0,0,0,.75);border-bottom-color:rgba(255,255,255,.08)}
  .brand{font-weight:700;letter-spacing:.3px;font-size:var(--brand-size)}
  .nav-links{display:flex;gap:10px;align-items:center}
  .nav-links .pill{padding:8px 14px;border-radius:999px;text-decoration:none;color:#fff;border:1px solid rgba(255,255,255,.2);font-weight:600;font-size:14px}
  .icon-btn{appearance:none;border:0;background:transparent;color:#fff;cursor:pointer;padding:8px;border-radius:10px}
  .icon-btn:hover{background:rgba(255,255,255,.12)}
  .login-btn{appearance:none;border:0;cursor:pointer;background:#fff;color:#111;padding:8px 16px;border-radius:999px;font-weight:600;box-shadow:var(--shadow)}
  #moreBtn{position:relative;touch-action:manipulation;user-select:none;z-index:1001;cursor:pointer;border:0;background:transparent;font-size:20px;line-height:1}
  #moreBtn::after{content:"";position:absolute;inset:-10px}
  .more-menu{position:absolute;right:80px;top:42px;display:none;flex-direction:column;gap:6px;background:rgba(0,0,0,.85);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;min-width:180px;box-shadow:var(--shadow)}
  .more-menu.show{display:flex}
  .more-menu a,.more-menu .linklike{color:#fff;text-decoration:none;padding:8px 10px;border-radius:8px;display:block;text-align:left;background:transparent;border:0;font:inherit;cursor:pointer}
  .more-menu a:hover,.more-menu .linklike:hover{background:rgba(255,255,255,.08)}

  /* Notebook layout */
  main{padding:120px 28px 80px;max-width:1200px;margin:0 auto}
  .wrapper{display:grid;gap:18px}
  .toolbar{display:flex;gap:10px;align-items:center;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px;flex-wrap:wrap;box-shadow:var(--shadow)}
  .toolbar .group{display:flex;gap:6px;align-items:center;padding-right:10px;border-right:1px solid #eee}
  .toolbar .group:last-child{border-right:0}
  .btn{appearance:none;border:1px solid #e5e7eb;padding:8px 12px;border-radius:10px;background:#fff;cursor:pointer}
  .btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .input{padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
  .color{height:34px;width:44px;padding:0;border-radius:8px;border:1px solid #e5e7eb}

  #nb-toolbar{display:flex;gap:8px;align-items:center;margin:8px 0 12px}
  #nb-toolbar .toolbtn{padding:.5rem .75rem;border:1px solid #cbd5e1;border-radius:8px;background:#f8fafc;cursor:pointer}

  #pageWrap{display:grid;gap:10px;justify-content:center}
  .page{position:relative;width:900px;aspect-ratio:210 / 297;background:#fff;border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
  .page-inner{position:absolute;inset:18px;border-radius:8px}
  #pageHeader{position:absolute;left:0;right:0;top:0;height:56px;display:flex;align-items:center;gap:10px;padding:8px 12px;background:rgba(255,255,255,.75);backdrop-filter:blur(6px);border-bottom:1px dashed #e5e7eb}
  .header-label{font-size:12px;color:#666;margin-right:4px}
  .note{color:#666;font-size:14px}

  /* Layers: bg -> text -> drawing */
  #bgCanvas,#drawCanvas,#rt{position:absolute;left:0;right:0;top:0;bottom:0;border-radius:8px}
  #bgCanvas{z-index:0}
  #rt{z-index:1;padding:12px;outline:none;overflow:auto;user-select:text; /* allow text selection */}
  #drawCanvas{z-index:2;pointer-events:auto;touch-action:none} /* drawing surface only */
  #rt img{max-width:100%;height:auto;border-radius:6px;display:inline-block}

  /* Selection/resize UI */
  .selectable{display:inline-block}
  .selectable.selected{outline:1px dashed #888;position:relative}
  .selectable.selected::after{content:"";position:absolute;right:-6px;bottom:-6px;width:12px;height:12px;border:1px solid #888;background:#fff;cursor:se-resize;border-radius:2px}

  .nb-table{border-collapse:collapse}
  .nb-table td{border:1px solid #aaa;min-width:60px;padding:4px}

  .wrap{border:1px dashed #bbb;padding:6px;border-radius:6px;display:inline-block;background:transparent}

  @media print{
    header,.toolbar,.note,#pageHeader{display:none!important}
    main{padding:0!important}
    .page{width:auto;aspect-ratio:auto;box-shadow:none;border-radius:0}
    .page-inner{inset:0}
  }
  @page{size:A4 portrait;margin:12mm}
</style>
</head>

<body>
<header class="site-header" id="siteHeader">
  <a class="brand" href="index.html">OOPQuizBot</a>
  <nav aria-label="Primary" class="nav-links">
    <a class="pill" href="announcements.html">Announcements</a>
    <a class="pill" href="ask-ai.html">Ask AI</a>
    <a class="pill" href="quiz.html">Quiz</a>
    <a class="pill" href="notebook.html">Notebook</a>
  </nav>
  <div class="header-actions">
    <button id="themeToggle" class="icon-btn" aria-label="Toggle light/dark mode" title="Light/Dark">
      <svg id="iconMoon" aria-hidden="true" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79z"/></svg>
      <svg id="iconSun"  aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" style="display:none"><path fill="currentColor" d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"/></svg>
    </button>
    <button id="moreBtn" class="icon-btn" aria-haspopup="menu" aria-expanded="false" title="More">
      <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24"><circle cx="5" cy="12" r="2" fill="currentColor"/><circle cx="12" cy="12" r="2" fill="currentColor"/><circle cx="19" cy="12" r="2" fill="currentColor"/></svg>
    </button>
    <div id="moreMenu" class="more-menu" role="menu" aria-label="More options">
      <a role="menuitem" href="revise.html">Revise Module</a>
      <a role="menuitem" href="founder.html">Founder</a>
      <a role="menuitem" href="leaderboard.html">Leaderboard</a>
      <a role="menuitem" href="account.html">Account Settings</a>
      <button id="logoutBtn" class="linklike" role="menuitem">Logout</button>
    </div>
    <a id="loginBtn" class="login-btn" href="login.html">Login</a>
  </div>
</header>

<main>
  <!-- Quick insert helpers -->
  <div id="nb-toolbar">
    <label class="toolbtn">üì∑ Insert Image <input id="imgPick" type="file" accept="image/*" hidden></label>
    <button id="btnInsertTable" class="toolbtn">‚ñ¶ Insert Table</button>
    <button id="btnWrapSelection" class="toolbtn">‚ñ° Wrap Selection</button>
    <button id="btnSelectTool" class="toolbtn" title="Select/Move/Resize">üñêÔ∏è Select</button>
  </div>

  <div class="wrapper">
    <div class="toolbar">
      <div class="group">
        <button id="toolText" class="btn active">Type</button>
        <button id="toolPencil" class="btn">Pencil</button>
        <button id="toolWriting" class="btn">Writing Pen</button>
        <button id="toolDrawing" class="btn">Drawing Pen</button>
        <button id="toolHighlighter" class="btn">Highlighter</button>
        <button id="toolHD" class="btn">HD Pen</button>
        <button id="toolEraser" class="btn">Eraser</button>
      </div>
      <div class="group">
        <label>Size <input id="size" type="range" min="1" max="32" value="6"></label>
        <label>Opacity <input id="opacity" type="range" min="0.1" max="1" step="0.05" value="0.95"></label>
        <input id="inkColor" class="color" type="color" value="#111111">
      </div>
      <div class="group">
        <select id="fontName" class="input">
          <option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial">System UI</option>
          <option value="'Times New Roman', Times, serif">Times New Roman</option>
          <option value="Georgia, Cambria, Times New Roman, Times, serif">Serif</option>
          <option value="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, monospace">Monospace</option>
        </select>
        <select id="fontSize" class="input">
          <option>12</option><option>14</option><option selected>16</option><option>18</option><option>20</option><option>22</option><option>24</option><option>28</option>
        </select>
        <input id="textColor" class="color" type="color" value="#111111" title="Text color">
        <input id="bgColor" class="color" type="color" value="#ffff88" title="Highlight">
        <button id="alignLeft" class="btn">Left</button>
        <button id="alignCenter" class="btn">Center</button>
        <button id="alignRight" class="btn">Right</button>
        <button id="clearFmt" class="btn">Clear</button>
        <label class="btn">Insert Image<input id="insertImg" type="file" accept="image/*" hidden></label>
      </div>

      <div class="group">
        <select id="layout" class="input">
          <option value="ruled" selected>Ruled</option>
          <option value="grid">Grid</option>
          <option value="dotted">Dotted</option>
          <option value="plain">Plain</option>
        </select>
        <label>Spacing <input id="spacing" type="range" min="12" max="40" value="24"></label>
        <span class="header-label">Layout Color</span><input id="layoutColor" class="color" type="color" value="#a1a1aa">
        <span class="header-label">Page Color</span><input id="pageColor" class="color" type="color" value="#ffffff">
        <label><input id="showMargin" type="checkbox" checked> Show margin</label>
        <span class="header-label">Margin</span><input id="marginColor" class="color" type="color" value="#ef4444">
      </div>

      <div class="group">
        <button id="newPage" class="btn">New Page</button>
        <button id="prevPage" class="btn">Prev</button>
        <button id="nextPage" class="btn">Next</button>
        <span id="pageIndicator" class="pager">Page 1 / 1</span>
      </div>

      <div class="group">
        <button id="save" class="btn">Save</button>
        <button id="load" class="btn">Load</button>
        <button id="export" class="btn">Export PNG</button>
        <button id="print" class="btn">Print / PDF</button>
        <button id="clear" class="btn">Clear Drawing</button>
      </div>
    </div>

    <div id="pageWrap">
      <div class="page" id="printArea">
        <div class="page-inner" id="pageInner">
          <div id="pageHeader">
            <span class="header-label">Title</span><input id="hTitle" class="input" placeholder="Notebook Title">
            <span class="header-label">Section</span><input id="hSection" class="input" placeholder="Section name">
            <span class="header-label">Page</span><input id="hPage" class="input" placeholder="1" style="width:60px">
            <span class="header-label">Date</span><input id="hDate" class="input" type="date" style="width:auto">
          </div>

          <!-- ‚úÖ background canvas (for page color + rulings) -->
          <canvas id="bgCanvas"></canvas>
          <div id="rt" contenteditable="true" placeholder="Type your notes here..."></div>
          <canvas id="drawCanvas"></canvas>
        </div>
      </div>
    </div>

    <div class="note">Use <strong>Insert Image/Table</strong> and the <strong>üñêÔ∏è Select</strong> tool to move/resize items. Print/PDF excludes the header.</div>
  </div>
</main>

<script>
/* ===== Header/theme + robust ‚ãØ menu (same as Home) ===== */
const header = document.getElementById('siteHeader');
const onScroll = () => { if (scrollY>10) header.classList.add('scrolled'); else header.classList.remove('scrolled'); };
onScroll(); addEventListener('scroll', onScroll, {passive:true});

const root=document.documentElement; const saved=localStorage.getItem('theme'); if(saved) root.setAttribute('data-theme',saved);
document.getElementById('themeToggle').addEventListener('click',()=>{ const isLight=root.getAttribute('data-theme')==='light'; root.setAttribute('data-theme',isLight?'dark':'light'); localStorage.setItem('theme',isLight?'dark':'light'); });

(function normalizeMoreBtn(){ const old=document.getElementById('moreBtn'); const clone=old.cloneNode(true); old.parentNode.replaceChild(clone,old); })();
const moreBtn=document.getElementById('moreBtn'), moreMenu=document.getElementById('moreMenu');
function openMenu(){ moreMenu.classList.add('show'); moreBtn.setAttribute('aria-expanded','true'); }
function closeMenu(){ moreMenu.classList.remove('show'); moreBtn.setAttribute('aria-expanded','false'); }
moreBtn.addEventListener('pointerup',(e)=>{ e.preventDefault(); e.stopPropagation(); moreMenu.classList.contains('show')?closeMenu():openMenu(); });
addEventListener('pointerdown',(e)=>{ if(moreMenu.classList.contains('show') && !moreMenu.contains(e.target) && e.target!==moreBtn) closeMenu(); },{capture:true});
document.getElementById('logoutBtn').addEventListener('click',()=>{ localStorage.clear(); alert('Logged out.'); location.href='login.html'; });
</script>

<script>
/* ========================= NOTEBOOK ENGINE ========================= */
(function(){
  // ---- DOM
  const bg = document.getElementById('bgCanvas');
  const fg = document.getElementById('drawCanvas');
  const rt = document.getElementById('rt');
  const ctxBg = bg.getContext('2d');
  const ctx = fg.getContext('2d');

  // ---- Tooling
  const toolButtons = {
    text:  document.getElementById('toolText'),
    pencil:document.getElementById('toolPencil'),
    writing:document.getElementById('toolWriting'),
    drawing:document.getElementById('toolDrawing'),
    highlighter:document.getElementById('toolHighlighter'),
    hd:    document.getElementById('toolHD'),
    eraser:document.getElementById('toolEraser')
  };
  const sizeEl=document.getElementById('size'), opacityEl=document.getElementById('opacity'), inkEl=document.getElementById('inkColor');
  const fontSel=document.getElementById('fontName'), fontSizeSel=document.getElementById('fontSize'), txtColorEl=document.getElementById('textColor'), bgColorEl=document.getElementById('bgColor');
  const alignLeft=document.getElementById('alignLeft'), alignCenter=document.getElementById('alignCenter'), alignRight=document.getElementById('alignRight'), clearFmt=document.getElementById('clearFmt');
  const insertImg=document.getElementById('insertImg'), imgPick=document.getElementById('imgPick');
  const layoutSel=document.getElementById('layout'), spacingEl=document.getElementById('spacing'), layoutColorEl=document.getElementById('layoutColor'), pageColorEl=document.getElementById('pageColor'), marginToggle=document.getElementById('showMargin'), marginColorEl=document.getElementById('marginColor');
  const hTitle=document.getElementById('hTitle'), hSection=document.getElementById('hSection'), hPage=document.getElementById('hPage'), hDate=document.getElementById('hDate');
  const btnNewPage=document.getElementById('newPage'), btnPrev=document.getElementById('prevPage'), btnNext=document.getElementById('nextPage'), pageIndicator=document.getElementById('pageIndicator');
  const btnInsertTable=document.getElementById('btnInsertTable'), btnWrapSelection=document.getElementById('btnWrapSelection'), btnSelectTool=document.getElementById('btnSelectTool');

  const me = window.OOP && OOP.getCurrentUser ? OOP.getCurrentUser() : null;
  const saveKey = me ? `oop.notebook.v6.${me?.email}` : 'oop.notebook.v6.anon';

  // ---- State
  let tool='text', pages=[], current=0;
  let drawing=false, lastPt=null;
  let hand=false, active=null;

  // ---- Caret memory (so toolbar inserts go into page, not toolbar)
  let savedRange=null;
  function saveRangeFromRT(){
    const sel=window.getSelection(); if(!sel || sel.rangeCount===0) return;
    const r=sel.getRangeAt(0);
    if (rt.contains(r.startContainer) && rt.contains(r.endContainer)) savedRange=r.cloneRange();
  }
  function focusRTAndRestore(place='end'){
    rt.focus();
    const sel=window.getSelection(); sel.removeAllRanges();
    if (savedRange){ sel.addRange(savedRange); }
    else {
      const r=document.createRange();
      r.selectNodeContents(rt);
      if (place==='start') r.collapse(true); else r.collapse(false);
      sel.addRange(r);
    }
  }
  rt.addEventListener('keyup',saveRangeFromRT);
  rt.addEventListener('mouseup',saveRangeFromRT);
  rt.addEventListener('input',saveRangeFromRT);
  document.addEventListener('selectionchange',()=>{ // keep latest, but only if inside rt
    saveRangeFromRT();
  });

  // ---- Tools
  function setActiveTool(t){
    tool=t;
    for(const k in toolButtons) toolButtons[k].classList.toggle('active', k===t);
    if (t==='text' || t==='hand'){ fg.style.pointerEvents='none'; rt.contentEditable = (t!=='hand'); if(t==='text') rt.focus(); }
    else { fg.style.pointerEvents='auto'; rt.contentEditable='true'; }
    if (t==='highlighter'){ opacityEl.value=0.35; sizeEl.value=Math.max(10, +sizeEl.value||10); }
    else if (t==='pencil'){ opacityEl.value=1; sizeEl.value=2; }
    else if (t==='writing'){ opacityEl.value=1; sizeEl.value=4; }
    else if (t==='drawing'){ opacityEl.value=1; sizeEl.value=8; }
    else if (t==='hd'){ opacityEl.value=0.95; sizeEl.value=Math.max(6, +sizeEl.value||6); }
  }
  toolButtons.text.addEventListener('click',()=>setActiveTool('text'));
  toolButtons.pencil.addEventListener('click',()=>setActiveTool('pencil'));
  toolButtons.writing.addEventListener('click',()=>setActiveTool('writing'));
  toolButtons.drawing.addEventListener('click',()=>setActiveTool('drawing'));
  toolButtons.highlighter.addEventListener('click',()=>setActiveTool('highlighter'));
  toolButtons.hd.addEventListener('click',()=>setActiveTool('hd'));
  toolButtons.eraser.addEventListener('click',()=>setActiveTool('eraser'));

  // ---- Canvas sizing + background
  function resizeCanvases(){
    const container=document.getElementById('pageInner'), header=document.getElementById('pageHeader');
    const rect=container.getBoundingClientRect(), width=Math.round(rect.width), height=Math.round(rect.height - header.offsetHeight);
    const dpr=window.devicePixelRatio||1;
    [bg,fg].forEach(c=>{
      const snap=(c===fg)?c.toDataURL():null;
      c.width=width*dpr; c.height=height*dpr; c.style.width=width+'px'; c.style.height=height+'px';
      c.style.top=header.offsetHeight+'px';
      const cctx=c.getContext('2d'); cctx.setTransform(1,0,0,1,0,0); cctx.scale(dpr,dpr);
      if(c===fg && snap && snap.length>100){ const img=new Image(); img.onload=()=>{ cctx.drawImage(img,0,0,width,height); }; img.src=snap; }
    });
    rt.style.top=header.offsetHeight+'px'; rt.style.height=(rect.height - header.offsetHeight)+'px';
    drawBackground();
  }
  function drawBackground(){
    const container=document.getElementById('pageInner'), header=document.getElementById('pageHeader');
    const rect=container.getBoundingClientRect(), w=Math.round(rect.width), h=Math.round(rect.height - header.offsetHeight);
    ctxBg.clearRect(0,0,w,h);
    ctxBg.fillStyle=pageColorEl.value||'#ffffff'; ctxBg.fillRect(0,0,w,h);
    const spacing=+spacingEl.value, lc=layoutColorEl.value; ctxBg.strokeStyle=lc; ctxBg.fillStyle=lc; ctxBg.globalAlpha=0.35; ctxBg.lineWidth=1;
    const layout=layoutSel.value;
    if(layout==='ruled' || layout==='grid'){ for(let y=0;y<h;y+=spacing){ ctxBg.beginPath(); ctxBg.moveTo(0,y); ctxBg.lineTo(w,y); ctxBg.stroke(); } }
    if(layout==='grid'){ for(let x=0;x<w;x+=spacing){ ctxBg.beginPath(); ctxBg.moveTo(x,0); ctxBg.lineTo(x,h); ctxBg.stroke(); } }
    if(layout==='dotted'){ const r=1.2; for(let y=0;y<h;y+=spacing){ for(let x=0;x<w;x+=spacing){ ctxBg.beginPath(); ctxBg.arc(x,y,r,0,Math.PI*2); ctxBg.fill(); } } }
    ctxBg.globalAlpha=1;
    if(marginToggle.checked){ ctxBg.strokeStyle=marginColorEl.value; ctxBg.lineWidth=2; ctxBg.beginPath(); ctxBg.moveTo(72,0); ctxBg.lineTo(72,h); ctxBg.stroke(); }
  }
  addEventListener('resize',resizeCanvases);

  // ---- Drawing (mouse/touch/pen with pressure)
  function getPos(e){ const r=fg.getBoundingClientRect(); const c=e.touches?e.touches[0]:e; return {x:c.clientX-r.left,y:c.clientY-r.top,t:e.timeStamp||Date.now(),p:c.pressure||0.5}; }
  function drawSegment(from,to,w,color,a){ ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=color; ctx.globalAlpha=a; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=w; ctx.beginPath(); ctx.moveTo(from.x,from.y); ctx.lineTo(to.x,to.y); ctx.stroke(); ctx.globalAlpha=1; }
  function stroke(from,to,e){
    const base=+sizeEl.value, alpha=+opacityEl.value;
    if(tool==='eraser'){ ctx.globalCompositeOperation='destination-out'; ctx.strokeStyle='#000'; ctx.lineWidth=base; ctx.beginPath(); ctx.moveTo(from.x,from.y); ctx.lineTo(to.x,to.y); ctx.stroke(); ctx.globalCompositeOperation='source-over'; return; }
    if(tool==='hd'){ const dt=Math.max(1,to.t-from.t); const dist=Math.hypot(to.x-from.x,to.y-from.y); const speed=Math.min(1,(dist/dt)/1.2); const pressure=e?.pressure ?? ((from.p+to.p)/2||0.5); const dynamic=(1-speed)*0.9 + pressure*0.6; const w=Math.max(0.5, base*(0.6+dynamic)); drawSegment(from,to,w,inkEl.value,Math.min(1,alpha)); drawSegment(from,to,w*0.6,inkEl.value,Math.min(1,alpha*0.7)); return; }
    drawSegment(from,to,base,inkEl.value,alpha);
  }
  fg.addEventListener('pointerdown',(e)=>{ if(tool==='text' || tool==='hand') return; drawing=true; lastPt=getPos(e); fg.setPointerCapture(e.pointerId); ctx.beginPath(); ctx.arc(lastPt.x,lastPt.y,Math.max(1,(+sizeEl.value*(0.5+(e.pressure||0.5)))/2),0,Math.PI*2); ctx.fillStyle=inkEl.value; ctx.fill(); });
  fg.addEventListener('pointermove',(e)=>{ if(!drawing) return; const p=getPos(e); stroke(lastPt,p,e); lastPt=p; });
  fg.addEventListener('pointerup',()=>{ drawing=false; });

  // ---- Text formatting (execCommand kept for simplicity)
  function exec(cmd,val=null){ document.execCommand(cmd,false,val); rt.focus(); }
  fontSel.addEventListener('change',()=>exec('fontName',fontSel.value));
  fontSizeSel.addEventListener('change',()=>{
    document.execCommand('fontSize',false,'4');
    rt.querySelectorAll('font[size="4"]').forEach(f=>{ f.removeAttribute('size'); f.style.fontFamily=fontSel.value; f.style.fontSize=fontSizeSel.value+'px'; });
    rt.focus();
  });
  txtColorEl.addEventListener('change',()=>exec('foreColor',txtColorEl.value));
  bgColorEl.addEventListener('change',()=>exec('hiliteColor',bgColorEl.value));
  alignLeft.addEventListener('click', ()=>exec('justifyLeft'));
  alignCenter.addEventListener('click',()=>exec('justifyCenter'));
  alignRight.addEventListener('click', ()=>exec('justifyRight'));
  clearFmt.addEventListener('click', ()=>exec('removeFormat'));

  // ---- Insert helpers (force insertion into RT)
  function insertAtCaret(node){
    focusRTAndRestore(); // ensure caret is inside RT
    const sel=window.getSelection(); if(!sel || sel.rangeCount===0){ rt.appendChild(node); return; }
    const range=sel.getRangeAt(0);
    if(!rt.contains(range.commonAncestorContainer)){ rt.appendChild(node); return; }
    range.deleteContents(); range.insertNode(node);
    range.setStartAfter(node); range.setEndAfter(node); sel.removeAllRanges(); sel.addRange(range);
    saveRangeFromRT();
  }
  function onImagePicked(file){
    if(!file) return;
    const rd=new FileReader();
    rd.onload=()=>{ const img=document.createElement('img'); img.src=rd.result; img.alt='Image'; img.className='selectable'; insertAtCaret(img); };
    rd.readAsDataURL(file);
  }
  insertImg.addEventListener('change',e=>{ onImagePicked(e.target.files?.[0]); e.target.value=''; });
  imgPick  .addEventListener('change',e=>{ onImagePicked(e.target.files?.[0]); e.target.value=''; });

  btnInsertTable.addEventListener('click',()=>{
    focusRTAndRestore();
    const t=document.createElement('table'); t.className='nb-table selectable';
    for(let r=0;r<2;r++){ const tr=document.createElement('tr'); for(let c=0;c<2;c++){ const td=document.createElement('td'); td.innerHTML='<br>'; tr.appendChild(td); } t.appendChild(tr); }
    insertAtCaret(t);
  });

  btnWrapSelection.addEventListener('click',()=>{
    // Wrap the currently selected text/content inside RT
    focusRTAndRestore();
    const sel=window.getSelection(); if(!sel || sel.rangeCount===0) return;
    const range=sel.getRangeAt(0);
    if(!rt.contains(range.commonAncestorContainer)) return;
    const box=document.createElement('div'); box.className='wrap selectable';
    try{
      range.surroundContents(box);
      sel.removeAllRanges();
      const r=document.createRange(); r.selectNodeContents(box); r.collapse(false); sel.addRange(r);
    }catch(_){
      const contents=range.cloneContents(); box.appendChild(contents);
      range.deleteContents(); range.insertNode(box);
    }
    saveRangeFromRT();
  });

  // ---- Hand/Select: move/resize images, tables, wrapped blocks
  btnSelectTool.addEventListener('click',()=>{ hand=!hand; btnSelectTool.classList.toggle('active',hand); setActiveTool(hand?'hand':'text'); if(!hand){ document.querySelectorAll('.selectable.selected').forEach(n=>n.classList.remove('selected')); active=null; } });
  rt.addEventListener('pointerdown',(e)=>{
    if(!hand) return;
    const target=e.target.closest('.selectable');
    document.querySelectorAll('.selectable.selected').forEach(n=>n.classList.remove('selected'));
    active = target || null; if(!active) return;
    active.classList.add('selected');

    // Ensure absolute positioning anchored to current screen position
    const pr=rt.getBoundingClientRect(), ar=active.getBoundingClientRect();
    if(getComputedStyle(active).position!=='absolute'){
      active.style.position='absolute';
      active.style.left=(ar.left-pr.left+rt.scrollLeft)+'px';
      active.style.top =(ar.top -pr.top +rt.scrollTop )+'px';
      active.style.width=ar.width+'px';
    }
    const sx=e.clientX, sy=e.clientY;
    const start={left:parseFloat(active.style.left)||0, top:parseFloat(active.style.top)||0, w:parseFloat(active.style.width)||ar.width, h:parseFloat(active.style.height)||ar.height};
    const isResize = (e.clientX > ar.right-16 && e.clientY > ar.bottom-16);

    function onMove(ev){
      const dx=ev.clientX - sx, dy=ev.clientY - sy;
      if(isResize){
        active.style.width =(Math.max(30, start.w + dx))+'px';
        active.style.height=(Math.max(30, start.h + dy))+'px';
      }else{
        active.style.left=(start.left + dx)+'px';
        active.style.top =(start.top  + dy)+'px';
      }
    }
    function onUp(){ removeEventListener('pointermove',onMove); removeEventListener('pointerup',onUp); }
    addEventListener('pointermove',onMove); addEventListener('pointerup',onUp);
  });

  // ---- Pages / persistence
  function pageSnapshot(){
    return { header:{title:hTitle.value,section:hSection.value,page:hPage.value,date:hDate.value},
      layout:{type:layoutSel.value,spacing:spacingEl.value,color:layoutColorEl.value,pageColor:pageColorEl.value,margin:marginToggle.checked,marginColor:marginColorEl.value},
      pen:{size:sizeEl.value,color:inkEl.value,opacity:opacityEl.value,lastTool:tool},
      drawing: fg.toDataURL(), text: rt.innerHTML };
  }
  function renderPage(obj){
    const hd=obj.header||{}; hTitle.value=hd.title||''; hSection.value=hd.section||''; hPage.value=hd.page||''; hDate.value=hd.date||new Date().toISOString().slice(0,10);
    const ly=obj.layout||{}; layoutSel.value=ly.type||'ruled'; spacingEl.value=ly.spacing||24; layoutColorEl.value=ly.color||'#a1a1aa'; pageColorEl.value=ly.pageColor||'#ffffff'; marginToggle.checked=!!ly.margin; marginColorEl.value=ly.marginColor||'#ef4444';
    const pn=obj.pen||{}; sizeEl.value=pn.size||6; inkEl.value=pn.color||'#111111'; opacityEl.value=pn.opacity||0.95; setActiveTool(pn.lastTool||'text');
    drawBackground();
    const rect=fg.getBoundingClientRect(); ctx.clearRect(0,0,rect.width,rect.height);
    if(obj.drawing){ const img=new Image(); img.onload=()=>{ ctx.clearRect(0,0,rect.width,rect.height); ctx.drawImage(img,0,0,rect.width,rect.height); }; img.src=obj.drawing; }
    rt.innerHTML=obj.text||''; updatePager();
  }
  function saveAll(){ pages[current]=pageSnapshot(); localStorage.setItem(saveKey, JSON.stringify({pages,current})); alert('Notebook saved'); }
  function loadAll(){
    const raw=localStorage.getItem(saveKey);
    if(!raw){ pages=[pageSnapshot()]; current=0; updatePager(); return; }
    try{ const data=JSON.parse(raw); pages=(Array.isArray(data.pages)&&data.pages.length)?data.pages:[pageSnapshot()]; current=Math.min(Math.max(0,data.current||0), pages.length-1); renderPage(pages[current]); }
    catch{ pages=[pageSnapshot()]; current=0; }
  }
  function newPage(){
    pages[current]=pageSnapshot();
    const base=pageSnapshot();
    const n=parseInt(base.header.page,10); if(!isNaN(n)) base.header.page=String(n+1);
    base.text=''; base.drawing=null; pages.splice(current+1,0,base); current+=1; renderPage(base); updatePager(); autoSaveSoon();
  }
  function goto(delta){ pages[current]=pageSnapshot(); const next=current+delta; if(next<0||next>=pages.length) return; current=next; renderPage(pages[current]); autoSaveSoon(); }
  function updatePager(){ pageIndicator.textContent=`Page ${current+1} / ${pages.length}`; }
  let saveTimer=null; function autoSaveSoon(){ clearTimeout(saveTimer); saveTimer=setTimeout(saveAll,400); }
  document.getElementById('save').addEventListener('click',saveAll);
  document.getElementById('load').addEventListener('click',loadAll);
  btnNewPage.addEventListener('click',newPage);
  btnPrev.addEventListener('click',()=>goto(-1));
  btnNext.addEventListener('click',()=>goto(1));

  // ---- Export / Print
  async function renderDomToImage(domHTML,w,h){
    const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}"><foreignObject width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="width:${w}px;height:${h}px;overflow:hidden;"><style>*{box-sizing:border-box}.rt-root{font:16px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#111;padding:12px}.rt-root img{max-width:100%;height:auto;border-radius:6px}</style>${domHTML}</div></foreignObject></svg>`;
    const url='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svg);
    return await new Promise(res=>{ const img=new Image(); img.onload=()=>res(img); img.src=url; });
  }
  async function composePageImage(){
    const container=document.getElementById('pageInner'), header=document.getElementById('pageHeader');
    const rect=container.getBoundingClientRect(); const w=Math.round(rect.width), h=Math.round(rect.height - header.offsetHeight);
    const tmp=document.createElement('canvas'), tctx=tmp.getContext('2d'); tmp.width=w; tmp.height=h;
    tctx.fillStyle=pageColorEl.value||'#ffffff'; tctx.fillRect(0,0,w,h);
    tctx.drawImage(bg,0,0,w,h); tctx.drawImage(fg,0,0,w,h);
    const dom=`<div class="rt-root" style="width:${w}px;height:${h}px;">${rt.innerHTML}</div>`;
    const img=await renderDomToImage(dom,w,h); tctx.drawImage(img,0,0,w,h); return tmp.toDataURL('image/png');
  }
  document.getElementById('export').addEventListener('click',async()=>{ const url=await composePageImage(); const a=document.createElement('a'); a.href=url; a.download='notebook-page.png'; a.click(); });
  document.getElementById('print').addEventListener('click',async()=>{ const url=await composePageImage(); const w=window.open('','_blank'); w.document.write(`<!DOCTYPE html><html><head><title>Print</title><style>html,body{margin:0}img{width:100%;height:auto}</style></head><body><img src="${url}"/></body></html>`); w.document.close(); w.onload=()=>w.print(); });

  // ---- Init
  hDate.value=new Date().toISOString().slice(0,10);
  setActiveTool('text');
  setTimeout(()=>{ resizeCanvases(); drawBackground(); loadAll(); updatePager(); },0);
})();
</script>
</body>
</html>
